<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VaultRunner Dashboard</title>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-color: #30363d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --accent-blue: #58a6ff;
      --accent-green: #3fb950;
      --accent-red: #f85149;
      --accent-yellow: #d29922;
      --accent-purple: #a371f7;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .logo span {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: normal;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-card .label {
      color: var(--text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 600;
    }

    .stat-card .sub {
      color: var(--text-muted);
      font-size: 13px;
      margin-top: 4px;
    }

    .stat-card.success .value { color: var(--accent-green); }
    .stat-card.info .value { color: var(--accent-blue); }
    .stat-card.warning .value { color: var(--accent-yellow); }
    .stat-card.purple .value { color: var(--accent-purple); }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }

    .tab {
      background: none;
      border: none;
      color: var(--text-secondary);
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-weight: 500;
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .table-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: var(--bg-tertiary);
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge.success {
      background: rgba(63, 185, 80, 0.15);
      color: var(--accent-green);
    }

    .badge.failed {
      background: rgba(248, 81, 73, 0.15);
      color: var(--accent-red);
    }

    .badge.in_progress {
      background: rgba(210, 153, 34, 0.15);
      color: var(--accent-yellow);
    }

    .badge.bundled {
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent-blue);
    }

    .badge.local {
      background: rgba(163, 113, 247, 0.15);
      color: var(--accent-purple);
    }

    .badge.community {
      background: rgba(63, 185, 80, 0.15);
      color: var(--accent-green);
    }

    .badge.already_logged_in {
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent-blue);
    }

    .badge.pending_2fa {
      background: rgba(210, 153, 34, 0.15);
      color: var(--accent-yellow);
    }

    .badge.abandoned {
      background: rgba(110, 118, 129, 0.15);
      color: var(--text-muted);
    }

    .confidence-bar {
      width: 80px;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: var(--accent-green);
      border-radius: 3px;
      transition: width 0.3s;
    }

    .domain-link {
      color: var(--accent-blue);
      text-decoration: none;
    }

    .domain-link:hover {
      text-decoration: underline;
    }

    .empty-state {
      text-align: center;
      padding: 48px;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .btn {
      background: var(--accent-blue);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn.danger {
      background: var(--accent-red);
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .refresh-btn {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .time-ago {
      color: var(--text-muted);
      font-size: 13px;
    }

    .detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .detail-modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      max-width: 800px;
      max-height: 80vh;
      width: 90%;
      overflow: auto;
      padding: 24px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
    }

    .step-list {
      list-style: none;
    }

    .step-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .step-item:last-child {
      border-bottom: none;
    }

    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .step-icon.success {
      background: rgba(63, 185, 80, 0.15);
      color: var(--accent-green);
    }

    .step-icon.failed {
      background: rgba(248, 81, 73, 0.15);
      color: var(--accent-red);
    }

    .step-content {
      flex: 1;
    }

    .step-action {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .step-details {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .contribute-banner {
      background: linear-gradient(135deg, rgba(163, 113, 247, 0.1), rgba(88, 166, 255, 0.1));
      border: 1px solid var(--accent-purple);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .contribute-banner h3 {
      color: var(--accent-purple);
      margin-bottom: 4px;
    }

    .contribute-banner p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .rule-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .rule-header {
      padding: 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .rule-header:hover {
      background: var(--bg-tertiary);
    }

    .rule-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .rule-title h3 {
      font-size: 16px;
      font-weight: 600;
    }

    .rule-meta {
      display: flex;
      gap: 16px;
      align-items: center;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .rule-details {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid var(--border-color);
    }

    .rule-card.expanded .rule-details {
      display: block;
    }

    .rule-card.expanded .rule-header {
      background: var(--bg-tertiary);
    }

    .detail-section {
      margin-top: 16px;
    }

    .detail-section h4 {
      color: var(--text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .detail-item {
      background: var(--bg-primary);
      border-radius: 6px;
      padding: 12px;
    }

    .detail-item .label {
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-item .value {
      color: var(--text-primary);
      font-size: 14px;
      margin-top: 4px;
      word-break: break-all;
    }

    .step-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--bg-primary);
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      margin: 4px;
    }

    .step-badge .order {
      background: var(--accent-blue);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }

    .general-rule-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .general-rule-card h3 {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .keyword-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .keyword {
      background: rgba(248, 81, 73, 0.15);
      color: var(--accent-red);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .keyword.preferred {
      background: rgba(63, 185, 80, 0.15);
      color: var(--accent-green);
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .contribute-banner {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">üîê</div>
        <div>
          <h1>VaultRunner <span>Dashboard</span></h1>
        </div>
      </div>
      <button class="btn refresh-btn" onclick="refreshData()">‚Üª Refresh</button>
    </header>

    <div id="contribute-banner" class="contribute-banner" style="display: none;">
      <div>
        <h3>üéâ Rules Ready to Contribute!</h3>
        <p id="contribute-text">You have rules ready to share with the community.</p>
      </div>
      <button class="btn" onclick="showContributeInfo()">Learn How</button>
    </div>

    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="label">Total Logins</div>
        <div class="value" id="stat-total">-</div>
      </div>
      <div class="stat-card success">
        <div class="label">Success Rate</div>
        <div class="value" id="stat-success">-</div>
      </div>
      <div class="stat-card info">
        <div class="label">Sites</div>
        <div class="value" id="stat-sites">-</div>
      </div>
      <div class="stat-card purple">
        <div class="label">Learned Rules</div>
        <div class="value" id="stat-rules">-</div>
        <div class="sub" id="stat-rules-breakdown"></div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-panel="sessions">Active Sessions</button>
      <button class="tab" data-panel="history">Login History</button>
      <button class="tab" data-panel="rules">Learned Rules</button>
      <button class="tab" data-panel="general">General Rules</button>
      <button class="tab" data-panel="debug">Debug Data</button>
      <button class="tab" data-panel="settings">Settings</button>
    </div>

    <div id="panel-sessions" class="panel active">
      <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
        Sites where VaultRunner helped you log in. These are sessions the agent assisted with.
      </p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Site</th>
              <th>Account</th>
              <th>VaultRunner Assisted With</th>
              <th>2FA Used</th>
              <th>Logged In</th>
            </tr>
          </thead>
          <tbody id="sessions-table">
            <tr>
              <td colspan="5" class="empty-state">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="panel-history" class="panel">
      <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
        Complete log of every login attempt. Click a row to see step-by-step details.
      </p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Domain</th>
              <th>Username</th>
              <th>Status</th>
              <th>Flow</th>
              <th>2FA</th>
              <th>Steps</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="history-table">
            <tr>
              <td colspan="7" class="empty-state">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="panel-rules" class="panel">
      <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
        Site-specific login patterns learned from your login attempts. Click a rule to see step details.
      </p>
      <div id="rules-list">
        <div class="empty-state">Loading...</div>
      </div>
    </div>

    <div id="panel-general" class="panel">
      <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
        Global rules applied to all login attempts.
      </p>
      <div id="general-rules-content">
        <div class="empty-state">Loading...</div>
      </div>
    </div>

    <div id="panel-debug" class="panel">
      <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
        Raw JSON data from VaultRunner. Useful for debugging and understanding what's stored.
      </p>
      <div class="actions" style="margin-bottom: 16px;">
        <button class="btn" onclick="loadDebugData()">Refresh Debug Data</button>
        <button class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);" onclick="copyDebugData()">Copy to Clipboard</button>
      </div>
      <div id="debug-content" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; max-height: 600px; overflow: auto;">
        <pre style="font-family: 'SF Mono', Monaco, monospace; font-size: 12px; color: var(--text-primary); white-space: pre-wrap; word-break: break-all;">Loading...</pre>
      </div>
    </div>

    <div id="panel-settings" class="panel">
      <div class="section-title">Data Management</div>
      <div class="actions">
        <button class="btn danger" onclick="clearHistory()">Clear Login History</button>
      </div>
      <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
        This will delete all login attempt history. Learned rules will be preserved.
      </p>
    </div>
  </div>

  <div id="detail-modal" class="detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Login Details</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
      });
    });

    // Time formatting
    function timeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    // Fetch and display stats
    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        const data = await res.json();

        document.getElementById('stat-total').textContent = data.attempts.total;
        document.getElementById('stat-success').textContent =
          data.attempts.total > 0 ? `${(data.attempts.successRate * 100).toFixed(0)}%` : '-';
        document.getElementById('stat-sites').textContent = data.attempts.uniqueSites;
        document.getElementById('stat-rules').textContent = data.rules.total;
        document.getElementById('stat-rules-breakdown').textContent =
          `${data.rules.bundled} bundled, ${data.rules.local} learned`;

        if (data.rules.contributable > 0) {
          document.getElementById('contribute-banner').style.display = 'flex';
          document.getElementById('contribute-text').textContent =
            `You have ${data.rules.contributable} rule${data.rules.contributable > 1 ? 's' : ''} ready to share with the community.`;
        }
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    // Fetch and display history
    async function loadHistory() {
      try {
        const res = await fetch('/api/history?limit=50');
        const data = await res.json();

        const tbody = document.getElementById('history-table');

        if (data.attempts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No login attempts yet. Use VaultRunner to log into sites and see your history here.</td></tr>';
          return;
        }

        // Helper to format outcome for display
        function formatOutcome(outcome) {
          const labels = {
            'success': 'Success',
            'failed': 'Failed',
            'in_progress': 'In Progress',
            'abandoned': 'Abandoned',
            'already_logged_in': 'Already Logged In',
            'pending_2fa': 'Pending 2FA'
          };
          return labels[outcome] || outcome;
        }

        tbody.innerHTML = data.attempts.map(a => `
          <tr onclick="showAttemptDetails('${a.id}')" style="cursor: pointer;">
            <td><span class="domain-link">${a.domain}</span></td>
            <td style="color: var(--text-secondary); font-size: 13px;">${a.username || '-'}</td>
            <td><span class="badge ${a.outcome}">${formatOutcome(a.outcome)}</span></td>
            <td>${a.flowType || '-'}</td>
            <td>${a.twoFactorSource || 'none'}</td>
            <td>${a.stepCount}</td>
            <td><span class="time-ago">${timeAgo(a.startedAt)}</span></td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Failed to load history:', err);
        document.getElementById('history-table').innerHTML =
          '<tr><td colspan="7" class="empty-state">Failed to load history</td></tr>';
      }
    }

    // Helper functions to generate human-readable rule descriptions
    function generateRuleSummary(rule) {
      const source = rule.learnedFrom === 'bundled' ? 'This is a pre-configured rule shipped with VaultRunner.' :
                     rule.learnedFrom === 'community' ? 'This rule was contributed by the VaultRunner community.' :
                     'This rule was learned from your login attempts.';

      const reliability = rule.confidence >= 0.8 ? 'highly reliable' :
                          rule.confidence >= 0.5 ? 'moderately reliable' : 'still being refined';

      return `${source} Based on ${rule.successCount + rule.failureCount} attempt(s), it's ${reliability} (${(rule.confidence * 100).toFixed(0)}% success rate).`;
    }

    function generateFlowDescription(rule) {
      if (rule.flowType === 'multi-step') {
        return `This site uses a multi-step login where username and password are entered on separate pages. VaultRunner will fill the username, click "Next" or "Continue", wait for the password page, then fill the password.`;
      }
      return `This site uses a single-page login where username and password are entered on the same page. VaultRunner fills both fields at once, then clicks the login button.`;
    }

    function generate2FADescription(rule) {
      const sources = {
        'sms': `VaultRunner will check your Messages app for SMS verification codes${rule.twoFactorSender ? ` from "${rule.twoFactorSender}"` : ''}.`,
        'email': `VaultRunner will check your Gmail for email verification codes${rule.twoFactorSender ? ` from "${rule.twoFactorSender}"` : ''}.`,
        'totp': `VaultRunner will get the TOTP code from 1Password (the authenticator code that refreshes every 30 seconds).`
      };
      return sources[rule.twoFactorSource] || 'Two-factor authentication handling is configured for this site.';
    }

    function generateReliabilityNote(rule) {
      const total = rule.successCount + rule.failureCount;
      if (total === 0) {
        return 'No login attempts recorded yet. The rule will improve as you use it.';
      }
      if (rule.confidence >= 0.9 && total >= 3) {
        return `Excellent! This rule has worked ${rule.successCount} out of ${total} times. It's ready for contribution to the community.`;
      }
      if (rule.confidence >= 0.7) {
        return `Good reliability with ${rule.successCount} successes out of ${total} attempts. A few more successful logins will increase confidence.`;
      }
      if (rule.failureCount > rule.successCount) {
        return `This rule has had ${rule.failureCount} failures. It may need adjustment - the site's login flow might have changed.`;
      }
      return `${rule.successCount} success(es) and ${rule.failureCount} failure(s). The rule is still learning the optimal login pattern.`;
    }

    function getStepTitle(step) {
      const titles = {
        'fill_username': 'Fill Username',
        'fill_password': 'Fill Password',
        'fill_credentials': 'Fill Credentials',
        'click_button': step.buttonText ? `Click "${step.buttonText}"` : 'Click Button',
        'fill_2fa': 'Fill 2FA Code',
        'wait': `Wait ${step.waitMs || 0}ms`
      };
      return titles[step.action] || step.action;
    }

    function getStepExplanation(step) {
      const explanations = {
        'fill_username': 'Enters the username/email from 1Password into the username field.',
        'fill_password': 'Enters the password from 1Password into the password field.',
        'fill_credentials': 'Enters both username and password from 1Password into the login form.',
        'click_button': step.buttonText
          ? `Clicks the "${step.buttonText}" button to proceed to the next step or submit the form.`
          : 'Clicks a button to proceed.',
        'fill_2fa': 'Enters the two-factor authentication code (from SMS, email, or TOTP).',
        'wait': `Pauses for ${step.waitMs || 0}ms to allow the page to load or process the previous action.`
      };
      return explanations[step.action] || 'Performs this action as part of the login flow.';
    }

    // Fetch and display rules with full details
    async function loadRules() {
      try {
        const res = await fetch('/api/rules');
        const data = await res.json();

        const container = document.getElementById('rules-list');

        if (data.sites.length === 0) {
          container.innerHTML = '<div class="empty-state">No rules yet. Login patterns will appear here as you use VaultRunner.</div>';
          return;
        }

        container.innerHTML = data.sites.map((r, idx) => `
          <div class="rule-card" id="rule-${idx}">
            <div class="rule-header" onclick="toggleRule(${idx})">
              <div class="rule-title">
                <div style="width: 24px; height: 24px; background: var(--bg-tertiary); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                  <img src="https://www.google.com/s2/favicons?domain=${r.domain}&sz=16" alt="" style="width: 16px; height: 16px;" onerror="this.style.display='none'">
                </div>
                <h3>${r.domain}</h3>
                <span class="badge ${r.learnedFrom}">${r.learnedFrom}</span>
              </div>
              <div class="rule-meta">
                <span>${r.flowType}</span>
                <span>2FA: ${r.twoFactorSource || 'none'}</span>
                <span>${r.successCount}/${r.successCount + r.failureCount} success</span>
                <span style="color: var(--accent-green);">${(r.confidence * 100).toFixed(0)}% conf</span>
                <span style="font-size: 16px;">‚ñº</span>
              </div>
            </div>
            <div class="rule-details">
              <div class="detail-section">
                <h4>Summary</h4>
                <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; line-height: 1.7;">
                  <p style="margin-bottom: 12px;">
                    <strong style="color: var(--accent-blue);">What this rule does:</strong><br>
                    ${generateRuleSummary(r)}
                  </p>
                  <p style="margin-bottom: 12px;">
                    <strong style="color: var(--accent-green);">Login flow:</strong><br>
                    ${generateFlowDescription(r)}
                  </p>
                  ${r.twoFactorSource && r.twoFactorSource !== 'none' ? `
                  <p style="margin-bottom: 12px;">
                    <strong style="color: var(--accent-yellow);">2FA handling:</strong><br>
                    ${generate2FADescription(r)}
                  </p>
                  ` : ''}
                  <p style="margin-bottom: 0;">
                    <strong style="color: var(--accent-purple);">Reliability:</strong><br>
                    ${generateReliabilityNote(r)}
                  </p>
                </div>
              </div>
              <div class="detail-section">
                <h4>Step-by-Step Breakdown</h4>
                <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px;">
                  ${(r.steps || []).map((s, i) => `
                    <div style="display: flex; gap: 12px; ${i > 0 ? 'margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);' : ''}">
                      <div style="background: var(--accent-blue); color: white; border-radius: 50%; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${s.order}</div>
                      <div>
                        <div style="font-weight: 500; margin-bottom: 4px;">${getStepTitle(s)}</div>
                        <div style="color: var(--text-secondary); font-size: 13px;">${getStepExplanation(s)}</div>
                      </div>
                    </div>
                  `).join('')}
                  ${(!r.steps || r.steps.length === 0) ? '<p style="color: var(--text-muted);">No steps recorded yet. This rule will be populated after a successful login.</p>' : ''}
                </div>
              </div>
              ${r.adaptations && r.adaptations.length > 0 ? `
              <div class="detail-section">
                <h4>Adaptations Made (${r.adaptations.length})</h4>
                <div style="background: rgba(163, 113, 247, 0.1); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 12px;">
                  <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">Changes made by the learning system based on login attempts:</p>
                  <ul style="margin: 0; padding-left: 20px; color: var(--accent-purple);">
                    ${r.adaptations.map(a => `<li style="margin-bottom: 4px;">${a}</li>`).join('')}
                  </ul>
                </div>
              </div>
              ` : ''}
              ${r.consecutiveFailures > 0 ? `
              <div class="detail-section">
                <h4>Current Issues</h4>
                <div style="background: rgba(248, 81, 73, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 12px;">
                  <p style="color: var(--accent-red); margin: 0;">
                    <strong>${r.consecutiveFailures} consecutive failure(s)</strong><br>
                    <span style="color: var(--text-secondary); font-size: 13px;">Last error: ${r.lastFailureReason || 'Unknown'}</span>
                  </p>
                </div>
              </div>
              ` : ''}
              ${r.learningNotes && r.learningNotes.length > 0 ? `
              <div class="detail-section">
                <h4>Learning Log (${r.learningNotes.length} entries)</h4>
                <div style="background: var(--bg-primary); border-radius: 8px; max-height: 300px; overflow-y: auto;">
                  ${r.learningNotes.slice().reverse().map(note => `
                    <div style="padding: 10px 12px; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px;">
                      <span style="font-size: 14px;">${note.type === 'success' ? '‚úÖ' : note.type === 'failure' ? '‚ùå' : note.type === 'adaptation' ? 'üîÑ' : 'üí°'}</span>
                      <div style="flex: 1;">
                        <div style="font-size: 13px; color: var(--text-primary);">${note.message}</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${new Date(note.timestamp).toLocaleString()}</div>
                        ${note.details ? `<pre style="font-size: 10px; color: var(--text-secondary); margin: 4px 0 0 0; overflow-x: auto;">${JSON.stringify(note.details, null, 2)}</pre>` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
              ` : ''}
              <div class="detail-section">
                <h4>Rule Properties</h4>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="label">Login URL</div>
                    <div class="value">${r.loginUrl || 'Not set'}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">Flow Type</div>
                    <div class="value">${r.flowType}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">2FA Source</div>
                    <div class="value">${r.twoFactorSource || 'none'}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">2FA Sender</div>
                    <div class="value">${r.twoFactorSender || 'Not set'}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">Confidence</div>
                    <div class="value">${(r.confidence * 100).toFixed(1)}%</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">Success Count</div>
                    <div class="value">${r.successCount}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">Failure Count</div>
                    <div class="value">${r.failureCount}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">Consecutive Failures</div>
                    <div class="value" style="color: ${r.consecutiveFailures > 0 ? 'var(--accent-red)' : 'var(--accent-green)'};">${r.consecutiveFailures}</div>
                  </div>
                  <div class="detail-item">
                    <div class="label">Last Updated</div>
                    <div class="value">${r.lastUpdated ? new Date(r.lastUpdated).toLocaleString() : 'Never'}</div>
                  </div>
                  ${r.alternativeButtonTexts && r.alternativeButtonTexts.length > 0 ? `
                  <div class="detail-item" style="grid-column: span 2;">
                    <div class="label">Known Working Buttons</div>
                    <div class="value">${r.alternativeButtonTexts.map(b => `"${b}"`).join(', ')}</div>
                  </div>
                  ` : ''}
                </div>
              </div>
              <div class="detail-section">
                <h4>Raw JSON</h4>
                <pre style="background: var(--bg-primary); padding: 12px; border-radius: 6px; font-size: 11px; overflow-x: auto; max-height: 200px;">${JSON.stringify(r, null, 2)}</pre>
              </div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Failed to load rules:', err);
        document.getElementById('rules-list').innerHTML =
          '<div class="empty-state">Failed to load rules</div>';
      }
    }

    function toggleRule(idx) {
      const card = document.getElementById(`rule-${idx}`);
      card.classList.toggle('expanded');
    }

    // Fetch and display general rules
    async function loadGeneralRules() {
      try {
        const res = await fetch('/api/rules');
        const data = await res.json();
        const gr = data.generalRules;

        document.getElementById('general-rules-content').innerHTML = `
          <div class="general-rule-card">
            <h3>Social Login Avoidance</h3>
            <p style="color: var(--text-primary); margin-bottom: 12px;">
              Avoid social login: <strong>${gr.avoidSocialLogin ? 'Yes' : 'No'}</strong>
            </p>
            <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Keywords to avoid (buttons containing these):</p>
            <div class="keyword-list">
              ${gr.socialLoginKeywords.map(k => `<span class="keyword">${k}</span>`).join('')}
            </div>
          </div>

          <div class="general-rule-card">
            <h3>Preferred Button Order</h3>
            <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Buttons tried in this order when submitting:</p>
            <div class="keyword-list">
              ${gr.preferredButtonOrder.map((k, i) => `<span class="keyword preferred">${i + 1}. ${k}</span>`).join('')}
            </div>
          </div>

          <div class="general-rule-card">
            <h3>Timing</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="label">Wait Between Steps</div>
                <div class="value">${gr.waitBetweenSteps}ms</div>
              </div>
              <div class="detail-item">
                <div class="label">Wait After Submit</div>
                <div class="value">${gr.waitAfterSubmit}ms</div>
              </div>
            </div>
          </div>

          <div class="general-rule-card">
            <h3>Raw JSON</h3>
            <pre style="background: var(--bg-primary); padding: 12px; border-radius: 6px; font-size: 11px; overflow-x: auto;">${JSON.stringify(gr, null, 2)}</pre>
          </div>
        `;
      } catch (err) {
        console.error('Failed to load general rules:', err);
        document.getElementById('general-rules-content').innerHTML =
          '<div class="empty-state">Failed to load general rules</div>';
      }
    }

    // Debug data
    let debugData = null;

    async function loadDebugData() {
      try {
        const res = await fetch('/api/debug/raw');
        debugData = await res.json();

        document.querySelector('#debug-content pre').textContent = JSON.stringify(debugData, null, 2);
      } catch (err) {
        console.error('Failed to load debug data:', err);
        document.querySelector('#debug-content pre').textContent = 'Failed to load debug data: ' + err.message;
      }
    }

    function copyDebugData() {
      if (debugData) {
        navigator.clipboard.writeText(JSON.stringify(debugData, null, 2))
          .then(() => alert('Debug data copied to clipboard!'))
          .catch(err => alert('Failed to copy: ' + err.message));
      }
    }

    // Show attempt details
    async function showAttemptDetails(id) {
      try {
        const res = await fetch(`/api/history/${id}`);
        const data = await res.json();

        // Format outcome for modal display
        const outcomeLabels = {
          'success': 'Success',
          'failed': 'Failed',
          'in_progress': 'In Progress',
          'abandoned': 'Abandoned',
          'already_logged_in': 'Already Logged In',
          'pending_2fa': 'Pending 2FA'
        };

        document.getElementById('modal-title').textContent = `Login to ${data.domain}`;
        document.getElementById('modal-body').innerHTML = `
          <div style="margin-bottom: 16px;">
            <span class="badge ${data.outcome}">${outcomeLabels[data.outcome] || data.outcome}</span>
            <span style="color: var(--text-muted); margin-left: 8px;">${new Date(data.startedAt).toLocaleString()}</span>
          </div>
          ${data.username ? `<p style="color: var(--text-secondary); margin-bottom: 16px;"><strong>Username:</strong> ${data.username}${data.itemTitle ? ` (${data.itemTitle})` : ''}</p>` : ''}
          ${data.errorMessage ? `<p style="color: var(--accent-red); margin-bottom: 16px;">${data.errorMessage}</p>` : ''}
          <h4 style="margin-bottom: 12px; color: var(--text-secondary);">Steps (${data.steps.length})</h4>
          <ul class="step-list">
            ${data.steps.map((s, i) => `
              <li class="step-item">
                <div class="step-icon ${s.result}">${s.result === 'success' ? '‚úì' : s.result === 'partial' ? '~' : '‚úó'}</div>
                <div class="step-content">
                  <div class="step-action">${s.action}${s.params?.buttonText ? ` "${s.params.buttonText}"` : ''}</div>
                  <div class="step-details">${s.details || ''}</div>
                </div>
              </li>
            `).join('')}
          </ul>
        `;
        document.getElementById('detail-modal').classList.add('active');
      } catch (err) {
        console.error('Failed to load attempt details:', err);
      }
    }

    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
    }

    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') closeModal();
    });

    // Clear history
    async function clearHistory() {
      if (!confirm('Are you sure you want to clear all login history?')) return;

      try {
        await fetch('/api/history/clear', { method: 'POST' });
        refreshData();
      } catch (err) {
        console.error('Failed to clear history:', err);
      }
    }

    // Show contribute info
    function showContributeInfo() {
      alert('To contribute your learned rules:\\n\\n1. Run: vaultrunner contribute-rules\\n2. This will generate a JSON file with your patterns\\n3. Create a Pull Request on GitHub\\n\\nYour patterns help everyone!');
    }

    // Fetch and display active sessions
    async function loadSessions() {
      try {
        const res = await fetch('/api/sessions');
        const data = await res.json();

        const tbody = document.getElementById('sessions-table');

        if (data.sessions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No active sessions yet. Use VaultRunner to log into sites and they\'ll appear here.</td></tr>';
          return;
        }

        tbody.innerHTML = data.sessions.map(s => `
          <tr onclick="showAttemptDetails('${s.attemptId}')" style="cursor: pointer;">
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 24px; height: 24px; background: var(--bg-tertiary); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                  <img src="https://www.google.com/s2/favicons?domain=${s.domain}&sz=16" alt="" style="width: 16px; height: 16px;" onerror="this.style.display='none'">
                </div>
                <span class="domain-link">${s.domain}</span>
              </div>
            </td>
            <td>
              <div style="display: flex; flex-direction: column;">
                <span style="color: var(--text-primary); font-weight: 500;">${s.username || '-'}</span>
                ${s.itemTitle ? `<span style="color: var(--text-muted); font-size: 12px;">${s.itemTitle}</span>` : ''}
              </div>
            </td>
            <td>
              <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                ${s.assistedBy.map(a => `<span class="badge success">${a}</span>`).join('')}
              </div>
            </td>
            <td>${s.twoFactorUsed ? '<span class="badge info">Yes</span>' : '<span style="color: var(--text-muted);">No</span>'}</td>
            <td><span class="time-ago">${timeAgo(s.loggedInAt)}</span></td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Failed to load sessions:', err);
        document.getElementById('sessions-table').innerHTML =
          '<tr><td colspan="5" class="empty-state">Failed to load sessions</td></tr>';
      }
    }

    // Refresh all data
    function refreshData() {
      loadStats();
      loadSessions();
      loadHistory();
      loadRules();
      loadGeneralRules();
      loadDebugData();
    }

    // Initial load
    refreshData();

    // Auto-refresh every 30 seconds
    setInterval(refreshData, 30000);
  </script>
</body>
</html>
